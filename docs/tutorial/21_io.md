# Ввод/вывод файлов (lib/io)

Модуль `lib/io` предоставляет функции для работы с файлами и консолью.

```rust
import "lib/io" (*)
```

## Чтение из консоли

### readLine

```rust
readLine() -> Option<String>
```

Читает строку из stdin. Возвращает `Zero` при EOF.

```rust
import "lib/io" (readLine)

print("Введите имя:")
match readLine() {
    Some(name) -> print("Привет, ${name}!")
    Zero -> print("EOF")
}
```

#### Чтение нескольких строк

```rust
import "lib/io" (readLine)

fun readAllLines() -> List<String> {
    lines = []
    while true {
        match readLine() {
            Some(line) -> lines = lines ++ [line]
            Zero -> break
        }
    }
    lines
}
```

## Работа с файлами

### fileRead

```rust
fileRead(path: String) -> Result<String, String>
```

Читает весь файл в строку.

```rust
import "lib/io" (fileRead)

match fileRead("data.txt") {
    Ok(content) -> print(content)
    Fail(err) -> print("Ошибка: ${err}")
}
```

### fileReadAt

```rust
fileReadAt(path: String, offset: Int, length: Int) -> Result<String, String>
```

Читает часть файла с указанной позиции.

```rust
import "lib/io" (fileReadAt)

// Прочитать 10 байт начиная с позиции 100
match fileReadAt("big_file.txt", 100, 10) {
    Ok(chunk) -> print(chunk)
    Fail(err) -> print("Ошибка: ${err}")
}
```

### fileWrite

```rust
fileWrite(path: String, content: String) -> Result<Int, String>
```

Записывает строку в файл (перезаписывает если существует). Возвращает количество записанных байт.

```rust
import "lib/io" (fileWrite)

match fileWrite("output.txt", "Hello, World!") {
    Ok(bytes) -> print("Записано ${bytes} байт")
    Fail(err) -> print("Ошибка: ${err}")
}
```

### fileAppend

```rust
fileAppend(path: String, content: String) -> Result<Int, String>
```

Добавляет строку в конец файла.

```rust
import "lib/io" (fileAppend)

fileAppend("log.txt", "Новая запись\n")
```

### fileExists

```rust
fileExists(path: String) -> Bool
```

Проверяет существование файла.

```rust
import "lib/io" (fileExists, fileRead)

if fileExists("config.txt") {
    config = fileRead("config.txt")
    // ...
} else {
    print("Конфиг не найден")
}
```

### fileSize

```rust
fileSize(path: String) -> Result<Int, String>
```

Возвращает размер файла в байтах.

```rust
import "lib/io" (fileSize)

match fileSize("data.bin") {
    Ok(size) -> print("Размер: ${size} байт")
    Fail(err) -> print("Ошибка: ${err}")
}
```

### fileDelete

```rust
fileDelete(path: String) -> Result<Nil, String>
```

Удаляет файл.

```rust
import "lib/io" (fileDelete)

match fileDelete("temp.txt") {
    Ok(_) -> print("Файл удалён")
    Fail(err) -> print("Ошибка: ${err}")
}
```

## Работа с директориями

### dirCreate

```rust
dirCreate(path: String) -> Result<Nil, String>
```

Создаёт директорию. Родительская директория должна существовать.

```rust
import "lib/io" (dirCreate)

match dirCreate("data") {
    Ok(_) -> print("Директория создана")
    Fail(err) -> print("Ошибка: ${err}")
}
```

### dirCreateAll

```rust
dirCreateAll(path: String) -> Result<Nil, String>
```

Создаёт директорию и все родительские директории.

```rust
import "lib/io" (dirCreateAll)

// Создаст data/, data/cache/, data/cache/temp/
dirCreateAll("data/cache/temp")
```

### dirRemove

```rust
dirRemove(path: String) -> Result<Nil, String>
```

Удаляет пустую директорию.

```rust
import "lib/io" (dirRemove)

match dirRemove("empty_dir") {
    Ok(_) -> print("Директория удалена")
    Fail(err) -> print("Ошибка: ${err}")  // не пустая?
}
```

### dirRemoveAll

```rust
dirRemoveAll(path: String) -> Result<Nil, String>
```

Рекурсивно удаляет директорию и всё её содержимое.

```rust
import "lib/io" (dirRemoveAll)

// Удалит temp/ со всем содержимым
dirRemoveAll("temp")
```

### dirList

```rust
dirList(path: String) -> Result<List<String>, String>
```

Возвращает список файлов и поддиректорий.

```rust
import "lib/io" (dirList)

match dirList(".") {
    Ok(items) -> {
        for item in items {
            print(item)
        }
    }
    Fail(err) -> print("Ошибка: ${err}")
}
```

### dirExists

```rust
dirExists(path: String) -> Bool
```

Проверяет существование директории.

```rust
import "lib/io" (dirExists, dirCreate)

if !dirExists("cache") {
    dirCreate("cache")
}
```

### isDir

```rust
isDir(path: String) -> Bool
```

Проверяет, является ли путь директорией.

```rust
import "lib/io" (isDir)

if isDir("data") {
    print("Это директория")
}
```

### isFile

```rust
isFile(path: String) -> Bool
```

Проверяет, является ли путь обычным файлом.

```rust
import "lib/io" (isFile, isDir)

path = "data.txt"
if isFile(path) {
    print("Это файл")
} else if isDir(path) {
    print("Это директория")
} else {
    print("Не существует")
}
```

## Оператор ? для упрощения

Оператор `?` автоматически разворачивает `Result` и пробрасывает ошибку:

```rust
import "lib/io" (fileRead, fileWrite)

fun copyFile(src: String, dst: String) -> Result<String, Int> {
    content = fileRead(src)?       // Fail -> сразу возврат
    bytes = fileWrite(dst, content)?
    Ok(bytes)
}

match copyFile("a.txt", "b.txt") {
    Ok(bytes) -> print("Скопировано ${bytes} байт")
    Fail(err) -> print("Ошибка: ${err}")
}
```

## Практические примеры

### Построчное чтение файла

```rust
import "lib/io" (fileRead)
import "lib/string" (stringLines)

fun readLines(path: String) -> Result<String, List<String>> {
    match fileRead(path) {
        Ok(content) -> Ok(stringLines(content))
        Fail(err) -> Fail(err)
    }
}
```

### Простой логгер

```rust
import "lib/io" (fileAppend)
import "lib/time" (timeNow)

fun log(message: String) -> Nil {
    timestamp = timeNow()
    line = "[${show(timestamp)}] ${message}\n"
    fileAppend("app.log", line)
    Nil
}

log("Application started")
log("Processing data...")
```

### Чтение конфигурации

```rust
import "lib/io" (fileRead, fileExists)
import "lib/string" (stringLines, stringSplit, stringTrim)
import "lib/list" (length, filter, map, foldl)
import "lib/map" (mapPut)

fun loadConfig(path: String) -> Result<String, Map<String, String>> {
    if !fileExists(path) {
        Fail("Config file not found")
    } else {
        match fileRead(path) {
            Fail(e) -> Fail(e)
            Ok(content) -> {
                lines = stringLines(content)
                    |> filter(fun(line) -> length(stringTrim(line)) > 0)
                    |> filter(fun(line) -> stringTrim(line)[0] != '#')
                
                config = foldl(fun(acc, line) -> {
                    parts = stringSplit(stringTrim(line), "=")
                    if length(parts) == 2 {
                        key = stringTrim(parts[0])
                        value = stringTrim(parts[1])
                        mapPut(acc, key, value)
                    } else { acc }
                }, %{}, lines)
                
                Ok(config)
            }
        }
    }
}
```

### Рекурсивный обход директории

```rust
import "lib/io" (dirList, isDir, isFile)
import "lib/path" (pathJoin)
import "lib/string" (stringEndsWith)

fun walkDir(path: String, callback: (String) -> Nil) -> Nil {
    match dirList(path) {
        Ok(items) -> {
            for item in items {
                fullPath = pathJoin([path, item])
                if isFile(fullPath) {
                    callback(fullPath)
                } else if isDir(fullPath) {
                    walkDir(fullPath, callback)
                }
            }
        }
        Fail(_) -> Nil
    }
}

// Найти все .txt файлы
walkDir(".", fun(path) -> {
    if stringEndsWith(path, ".txt") {
        print(path)
    }
})
```

### Создание временной директории

```rust
import "lib/io" (dirCreateAll, dirRemoveAll, fileWrite)
import "lib/rand" (randString)

fun withTempDir(callback: (String) -> Nil) -> Nil {
    tempPath = "/tmp/app_" ++ randString(8)
    match dirCreateAll(tempPath) {
        Ok(_) -> {
            callback(tempPath)
            match dirRemoveAll(tempPath) {
                Ok(_) -> Nil
                Fail(_) -> Nil
            }
        }
        Fail(_) -> Nil
    }
}

// Использование
withTempDir(fun(dir) -> {
    fileWrite(dir ++ "/data.txt", "temporary data")
    // ... работа с временными файлами
})
```

## Обработка ошибок

Все функции работы с файлами возвращают `Result<T, String>`:
- `Ok(value)` — успех
- `Fail(errorMessage)` — ошибка с описанием

Типичные ошибки:
- "file not found" — файл не существует
- "permission denied" — нет прав доступа
- "is a directory" — путь указывает на директорию

## Сводка

| Функция | Тип | Описание |
|---------|-----|----------|
| `readLine` | `() -> Option<String>` | Читать строку из stdin |
| `fileRead` | `(String) -> Result<String, String>` | Читать весь файл |
| `fileReadAt` | `(String, Int, Int) -> Result<String, String>` | Читать часть файла |
| `fileWrite` | `(String, String) -> Result<Int, String>` | Записать файл |
| `fileAppend` | `(String, String) -> Result<Int, String>` | Дописать в файл |
| `fileExists` | `(String) -> Bool` | Проверить существование файла |
| `fileSize` | `(String) -> Result<Int, String>` | Размер файла |
| `fileDelete` | `(String) -> Result<Nil, String>` | Удалить файл |
| `dirCreate` | `(String) -> Result<Nil, String>` | Создать директорию |
| `dirCreateAll` | `(String) -> Result<Nil, String>` | Создать директорию рекурсивно |
| `dirRemove` | `(String) -> Result<Nil, String>` | Удалить пустую директорию |
| `dirRemoveAll` | `(String) -> Result<Nil, String>` | Удалить директорию рекурсивно |
| `dirList` | `(String) -> Result<List<String>, String>` | Содержимое директории |
| `dirExists` | `(String) -> Bool` | Проверить существование директории |
| `isDir` | `(String) -> Bool` | Это директория? |
| `isFile` | `(String) -> Bool` | Это файл? |

