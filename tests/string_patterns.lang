// String Pattern Tests
// Tests for string patterns with captures like "/hello/{name}"

import "lib/test" (*)

testRun("Basic capture", fun() {
    path = "/hello/world"
    result = match path {
        "/hello/{name}" -> name
        _ -> "fail"
    }
    assertEquals(result, "world")
})

testRun("Multiple captures", fun() {
    path = "/users/42/posts/123"
    (userId, postId) = match path {
        "/users/{userId}/posts/{postId}" -> (userId, postId)
        _ -> ("", "")
    }
    assertEquals(userId, "42")
    assertEquals(postId, "123")
})

testRun("Greedy capture", fun() {
    path = "/static/css/main/style.css"
    result = match path {
        "/static/{file...}" -> file
        _ -> "fail"
    }
    assertEquals(result, "css/main/style.css")
})

testRun("Tuple with string pattern", fun() {
    method = "GET"
    path = "/api/users/john"
    result = match (method, path) {
        ("GET", "/api/users/{name}") -> "Get user: " ++ name
        ("POST", "/api/users") -> "Create user"
        ("DELETE", "/api/users/{name}") -> "Delete user: " ++ name
        _ -> "Not found"
    }
    assertEquals(result, "Get user: john")
})

testRun("No match fallback", fun() {
    path = "/other/path"
    result = match path {
        "/hello/{name}" -> name
        _ -> "no match"
    }
    assertEquals(result, "no match")
})

testRun("Empty capture", fun() {
    path = "/prefix/"
    result = match path {
        "/prefix/{suffix}" -> "got: [" ++ suffix ++ "]"
        _ -> "no match"
    }
    assertEquals(result, "got: []")
})

testRun("Literal only pattern", fun() {
    path = "/exact/match"
    result = match path {
        "/exact/match" -> "matched"
        "/exact/{other}" -> "captured"
        _ -> "none"
    }
    assertEquals(result, "matched")
})

testRun("Mixed literal and capture", fun() {
    url = "/v1/api/resource/42/action"
    result = match url {
        "/v1/api/{resource}/{id}/action" -> resource ++ ":" ++ id
        _ -> "fail"
    }
    assertEquals(result, "resource:42")
})

print("string_patterns: all tests passed!")
